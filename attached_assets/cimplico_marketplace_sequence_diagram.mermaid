sequenceDiagram
    participant 用户
    participant 前端
    participant API网关
    participant 用户服务
    participant 商品服务
    participant 订单服务
    participant 支付服务
    participant 评论服务
    participant 数据库
    participant 文件存储
    
    %% 用户注册流程
    用户->>前端: 填写注册信息
    前端->>API网关: POST /api/v1/auth/register
    API网关->>用户服务: 创建用户
    用户服务->>数据库: 检查邮箱是否存在
    数据库-->>用户服务: 返回检查结果
    用户服务->>数据库: 创建用户记录
    数据库-->>用户服务: 创建成功
    用户服务->>用户服务: 发送验证邮件
    用户服务-->>API网关: 返回注册结果
    API网关-->>前端: 返回成功响应
    前端-->>用户: 显示注册成功
    
    %% 用户登录流程
    用户->>前端: 输入邮箱和密码
    前端->>API网关: POST /api/v1/auth/login
    API网关->>用户服务: 验证用户凭据
    用户服务->>数据库: 查询用户记录
    数据库-->>用户服务: 返回用户数据
    用户服务->>用户服务: 验证密码
    用户服务->>用户服务: 生成JWT令牌
    用户服务-->>API网关: 返回令牌和用户信息
    API网关-->>前端: 返回登录响应
    前端->>前端: 存储令牌
    前端-->>用户: 显示登录成功
    
    %% 商家注册流程
    用户->>前端: 填写商家信息
    前端->>API网关: POST /api/v1/vendors
    API网关->>用户服务: 创建商家档案
    用户服务->>数据库: 查询用户角色
    数据库-->>用户服务: 返回用户数据
    用户服务->>数据库: 创建VendorProfile记录
    数据库-->>用户服务: 创建成功
    用户服务-->>API网关: 返回创建结果
    API网关-->>前端: 返回响应
    前端-->>用户: 显示审核中状态
    
    %% 管理员审核商家流程
    用户->>前端: 查看待审核商家列表
    前端->>API网关: GET /api/v1/admin/vendors/pending
    API网关->>用户服务: 获取待审核商家
    用户服务->>数据库: 查询PENDING状态的商家
    数据库-->>用户服务: 返回商家列表
    用户服务-->>API网关: 返回商家列表
    API网关-->>前端: 返回响应
    前端-->>用户: 显示待审核商家
    用户->>前端: 提交审核结果
    前端->>API网关: PATCH /api/v1/admin/vendors/{id}
    API网关->>用户服务: 更新商家状态
    用户服务->>数据库: 更新VendorProfile状态
    数据库-->>用户服务: 更新成功
    用户服务->>用户服务: 发送通知给商家
    用户服务-->>API网关: 返回更新结果
    API网关-->>前端: 返回响应
    前端-->>用户: 显示审核完成
    
    %% 商家发布商品流程
    用户->>前端: 填写商品信息
    前端->>API网关: POST /api/v1/vendors/{id}/listings
    API网关->>商品服务: 创建商品
    商品服务->>数据库: 查询商家状态
    数据库-->>商品服务: 返回商家数据
    商品服务->>文件存储: 上传商品图片
    文件存储-->>商品服务: 返回图片URL
    商品服务->>数据库: 创建Listing记录
    数据库-->>商品服务: 创建成功
    商品服务-->>API网关: 返回商品信息
    API网关-->>前端: 返回响应
    前端-->>用户: 显示商品创建成功
    
    %% 管理员审核商品流程
    用户->>前端: 查看待审核商品
    前端->>API网关: GET /api/v1/admin/listings/pending
    API网关->>商品服务: 获取待审核商品
    商品服务->>数据库: 查询PENDING状态的商品
    数据库-->>商品服务: 返回商品列表
    商品服务-->>API网关: 返回商品列表
    API网关-->>前端: 返回响应
    前端-->>用户: 显示待审核商品
    用户->>前端: 提交审核结果
    前端->>API网关: PATCH /api/v1/admin/listings/{id}
    API网关->>商品服务: 更新商品状态
    商品服务->>数据库: 更新Listing状态
    数据库-->>商品服务: 更新成功
    商品服务->>商品服务: 发送通知给商家
    商品服务-->>API网关: 返回更新结果
    API网关-->>前端: 返回响应
    前端-->>用户: 显示审核完成
    
    %% 用户浏览商品流程
    用户->>前端: 浏览商品列表
    前端->>API网关: GET /api/v1/listings
    API网关->>商品服务: 获取商品列表
    商品服务->>数据库: 查询商品数据
    数据库-->>商品服务: 返回商品数据
    商品服务-->>API网关: 返回商品列表
    API网关-->>前端: 返回响应
    前端-->>用户: 显示商品列表
    用户->>前端: 点击商品详情
    前端->>API网关: GET /api/v1/listings/{id}
    API网关->>商品服务: 获取商品详情
    商品服务->>数据库: 查询商品数据
    数据库-->>商品服务: 返回商品数据
    商品服务->>数据库: 查询商品评论
    数据库-->>商品服务: 返回评论数据
    商品服务-->>API网关: 返回商品详情
    API网关-->>前端: 返回响应
    前端-->>用户: 显示商品详情
    
    %% 用户下单流程
    用户->>前端: 添加商品到购物车
    前端->>前端: 更新购物车
    用户->>前端: 结算购物车
    前端->>API网关: POST /api/v1/orders
    API网关->>订单服务: 创建订单
    订单服务->>数据库: 查询商品信息
    数据库-->>订单服务: 返回商品数据
    订单服务->>数据库: 创建Order记录
    数据库-->>订单服务: 创建成功
    订单服务->>数据库: 创建OrderItem记录
    数据库-->>订单服务: 创建成功
    订单服务-->>API网关: 返回订单信息
    API网关-->>前端: 返回响应
    前端-->>用户: 显示订单创建成功
    用户->>前端: 选择支付方式并支付
    前端->>API网关: POST /api/v1/payments
    API网关->>支付服务: 处理支付请求
    支付服务->>支付服务: 模拟支付处理
    支付服务->>数据库: 创建Payment记录
    数据库-->>支付服务: 创建成功
    支付服务->>订单服务: 通知支付成功
    订单服务->>数据库: 更新订单状态为PAID
    数据库-->>订单服务: 更新成功
    订单服务-->>支付服务: 确认状态更新
    支付服务-->>API网关: 返回支付结果
    API网关-->>前端: 返回响应
    前端-->>用户: 显示支付成功
    
    %% 商家处理订单流程
    用户->>前端: 查看新订单
    前端->>API网关: GET /api/v1/vendors/{id}/orders
    API网关->>订单服务: 获取商家订单
    订单服务->>数据库: 查询订单数据
    数据库-->>订单服务: 返回订单数据
    订单服务-->>API网关: 返回订单列表
    API网关-->>前端: 返回响应
    前端-->>用户: 显示订单列表
    用户->>前端: 更新订单状态(发货)
    前端->>API网关: PATCH /api/v1/vendors/{id}/orders/{order_id}
    API网关->>订单服务: 更新订单状态
    订单服务->>数据库: 更新Order状态为SHIPPED
    数据库-->>订单服务: 更新成功
    订单服务->>订单服务: 发送通知给用户
    订单服务-->>API网关: 返回更新结果
    API网关-->>前端: 返回响应
    前端-->>用户: 显示更新成功
    
    %% 用户评论流程
    用户->>前端: 填写商品评论
    前端->>API网关: POST /api/v1/listings/{id}/comments
    API网关->>评论服务: 创建评论
    评论服务->>数据库: 查询订单记录(验证购买)
    数据库-->>评论服务: 返回订单数据
    评论服务->>评论服务: 检查内容合规性
    评论服务->>数据库: 创建Comment记录
    数据库-->>评论服务: 创建成功
    评论服务-->>API网关: 返回评论信息
    API网关-->>前端: 返回响应
    前端-->>用户: 显示评论提交成功